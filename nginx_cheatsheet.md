## **Nginx Cheatsheet**

---

### **Основные команды**

| Команда                                      | Описание                                                                 |
|----------------------------------------------|-------------------------------------------------------------------------|
| `nginx -t`                                   | Проверить конфигурацию на ошибки.                                       |
| `nginx -s reload`                            | Перезагрузить конфигурацию без остановки сервера.                       |
| `nginx -s stop`                              | Остановить сервер.                                                      |
| `nginx -s quit`                              | Остановить сервер после завершения всех текущих запросов.               |
| `nginx -s reopen`                            | Переоткрыть лог-файлы.                                                  |
| `nginx -v`                                   | Показать версию Nginx.                                                  |
| `nginx -V`                                   | Показать версию Nginx и параметры сборки.                               |

---

### **Основные пути**

| Путь                                         | Описание                                                                 |
|----------------------------------------------|-------------------------------------------------------------------------|
| `/etc/nginx/nginx.conf`                      | Основной конфигурационный файл.                                         |
| `/etc/nginx/conf.d/`                         | Директория для дополнительных конфигураций.                             |
| `/etc/nginx/sites-available/`                | Доступные конфигурации виртуальных хостов.                              |
| `/etc/nginx/sites-enabled/`                  | Активированные конфигурации виртуальных хостов (симлинки).              |
| `/var/log/nginx/access.log`                  | Лог доступа (access log).                                               |
| `/var/log/nginx/error.log`                   | Лог ошибок (error log).                                                 |
| `/usr/share/nginx/html/`                     | Стандартная директория для статического контента.                       |

---

### **Основные директивы**

#### **Основные блоки**
| Директива                                    | Описание                                                                 |
|----------------------------------------------|-------------------------------------------------------------------------|
| `events { ... }`                             | Настройки обработки соединений.                                         |
| `http { ... }`                               | Настройки HTTP-сервера.                                                 |
| `server { ... }`                             | Конфигурация виртуального хоста.                                        |
| `location { ... }`                           | Конфигурация для определённого пути (URL).                              |

#### **Основные настройки**
| Директива                                    | Описание                                                                 |
|----------------------------------------------|-------------------------------------------------------------------------|
| `listen 80;`                                 | Порт, на котором сервер ожидает запросы.                                |
| `server_name example.com;`                   | Имя сервера (домен).                                                    |
| `root /var/www/html;`                        | Корневая директория для статического контента.                          |
| `index index.html;`                          | Файл, который будет отображаться по умолчанию.                          |
| `error_page 404 /404.html;`                  | Страница для ошибки 404.                                                |
| `access_log /var/log/nginx/access.log;`      | Лог доступа.                                                            |
| `error_log /var/log/nginx/error.log warn;`   | Лог ошибок с уровнем предупреждений.                                    |

#### **Location**
| Директива                                    | Описание                                                                 |
|----------------------------------------------|-------------------------------------------------------------------------|
| `location / { ... }`                         | Обработка запросов к корневому пути.                                    |
| `location /images/ { ... }`                  | Обработка запросов к `/images/`.                                        |
| `location ~ \.php$ { ... }`                  | Обработка PHP-файлов (регулярное выражение).                            |
| `try_files $uri $uri/ =404;`                 | Попытка найти файл или вернуть 404.                                     |
| `proxy_pass http://backend;`                 | Перенаправление запросов на другой сервер.                              |

---

### **Пример конфигурации**

#### **Простой виртуальный хост**
```nginx
server {
    listen 80;
    server_name example.com;

    root /var/www/example.com;
    index index.html;

    location / {
        try_files $uri $uri/ =404;
    }

    error_page 404 /404.html;
    location = /404.html {
        internal;
    }
}
```

#### **Проксирование на бэкенд**
```nginx
server {
    listen 80;
    server_name api.example.com;

    location / {
        proxy_pass http://localhost:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
}
```

#### **Обработка PHP через FastCGI**
```nginx
server {
    listen 80;
    server_name example.com;

    root /var/www/example.com;
    index index.php index.html;

    location / {
        try_files $uri $uri/ =404;
    }

    location ~ \.php$ {
        include snippets/fastcgi-php.conf;
        fastcgi_pass unix:/var/run/php/php7.4-fpm.sock;
    }
}
```

---

### **Полезные советы**

1. **Проверка конфигурации:**
   Всегда проверяйте конфигурацию перед перезагрузкой:
   ```bash
   nginx -t
   ```

2. **Перезагрузка Nginx:**
   После изменения конфигурации перезагрузите Nginx:
   ```bash
   nginx -s reload
   ```

3. **Логирование:**
   - Логи доступа: `/var/log/nginx/access.log`
   - Логи ошибок: `/var/log/nginx/error.log`

4. **Ротация логов:**
   Используйте `logrotate` для автоматической ротации логов:
   ```bash
   sudo nano /etc/logrotate.d/nginx
   ```

5. **Безопасность:**
   - Отключите ненужные модули.
   - Используйте HTTPS с Let's Encrypt.
   - Ограничьте доступ к служебным директориям.

---

### **Пример использования Let's Encrypt**

1. Установите Certbot:
   ```bash
   sudo apt install certbot python3-certbot-nginx
   ```

2. Получите сертификат:
   ```bash
   sudo certbot --nginx -d example.com
   ```

3. Настройте автоматическое обновление сертификатов:
   ```bash
   sudo certbot renew --dry-run
   ```

---

### **Заключение**
Этот cheatsheet охватывает основные команды, директивы и примеры конфигурации Nginx. Используйте его как справочник для быстрой настройки и управления вашим веб-сервером.
