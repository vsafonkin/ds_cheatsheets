## **PostgreSQL Cheatsheet: Управление пользователями и ролями**

---

### **Основные понятия**
- **Роли (Roles):** В PostgreSQL пользователи и группы объединены в концепцию "ролей". Роль может быть пользователем или группой.
- **Пользователь (User):** Роль с правом входа в базу данных.
- **Группа (Group):** Роль, которая объединяет другие роли (пользователей или группы).

---

### **Создание и удаление ролей**

| Команда                                      | Описание                                                                 |
|----------------------------------------------|-------------------------------------------------------------------------|
| `CREATE ROLE имя_роли;`                      | Создать новую роль.                                                     |
| `CREATE ROLE имя_роли WITH LOGIN;`           | Создать роль с правом входа (пользователь).                             |
| `CREATE ROLE имя_роли WITH SUPERUSER;`       | Создать роль с правами суперпользователя.                               |
| `CREATE ROLE имя_роли WITH PASSWORD 'пароль';`| Создать роль с паролем.                                                |
| `DROP ROLE имя_роли;`                        | Удалить роль.                                                           |

---

### **Изменение ролей**

| Команда                                      | Описание                                                                 |
|----------------------------------------------|-------------------------------------------------------------------------|
| `ALTER ROLE имя_роли WITH LOGIN;`            | Разрешить роль входить в систему.                                       |
| `ALTER ROLE имя_роли WITH NOLOGIN;`          | Запретить роль входить в систему.                                       |
| `ALTER ROLE имя_роли WITH SUPERUSER;`        | Дать роль права суперпользователя.                                      |
| `ALTER ROLE имя_роли WITH NOSUPERUSER;`      | Забрать права суперпользователя у роли.                                 |
| `ALTER ROLE имя_роли WITH PASSWORD 'пароль';`| Изменить пароль роли.                                                   |
| `ALTER ROLE имя_роли RENAME TO новое_имя;`   | Переименовать роль.                                                     |

---

### **Управление правами доступа**

| Команда                                      | Описание                                                                 |
|----------------------------------------------|-------------------------------------------------------------------------|
| `GRANT право ON объект TO роль;`             | Дать право на объект (таблицу, схему и т.д.) роли.                      |
| `REVOKE право ON объект FROM роль;`          | Забрать право на объект у роли.                                         |
| `GRANT ALL PRIVILEGES ON DATABASE имя_бд TO роль;`| Дать все права на базу данных роли.                                  |
| `REVOKE ALL PRIVILEGES ON DATABASE имя_бд FROM роль;`| Забрать все права на базу данных у роли.                          |

---

### **Примеры прав доступа**

| Право                                       | Описание                                                                 |
|----------------------------------------------|-------------------------------------------------------------------------|
| `SELECT`                                    | Право на чтение данных из таблицы.                                       |
| `INSERT`                                    | Право на вставку данных в таблицу.                                       |
| `UPDATE`                                    | Право на обновление данных в таблице.                                    |
| `DELETE`                                    | Право на удаление данных из таблицы.                                     |
| `CREATE`                                    | Право на создание объектов (таблиц, схем и т.д.).                        |
| `CONNECT`                                   | Право на подключение к базе данных.                                      |
| `USAGE`                                     | Право на использование схемы или последовательности.                    |

---

### **Примеры использования**

#### **Создание пользователя**
```sql
CREATE ROLE myuser WITH LOGIN PASSWORD 'mypassword';
```

#### **Создание группы**
```sql
CREATE ROLE mygroup;
```

#### **Добавление пользователя в группу**
```sql
GRANT mygroup TO myuser;
```

#### **Дать права на базу данных**
```sql
GRANT ALL PRIVILEGES ON DATABASE mydb TO myuser;
```

#### **Дать права на таблицу**
```sql
GRANT SELECT, INSERT, UPDATE ON TABLE mytable TO myuser;
```

#### **Забрать права**
```sql
REVOKE INSERT ON TABLE mytable FROM myuser;
```

#### **Изменение пароля**
```sql
ALTER ROLE myuser WITH PASSWORD 'newpassword';
```

---

### **Просмотр информации о ролях**

| Команда                                      | Описание                                                                 |
|----------------------------------------------|-------------------------------------------------------------------------|
| `\du`                                       | Показать список всех ролей.                                             |
| `\du+`                                      | Показать список всех ролей с дополнительной информацией.                |
| `SELECT * FROM pg_roles;`                   | Показать список всех ролей (SQL-запрос).                                |
| `SELECT * FROM pg_user;`                    | Показать список пользователей (SQL-запрос).                             |

---

### **Управление подключениями к базам данных**

| Команда                                      | Описание                                                                 |
|----------------------------------------------|-------------------------------------------------------------------------|
| `ALTER ROLE имя_роли WITH CONNECTION LIMIT 10;`| Ограничить количество подключений для роли (например, 10).             |
| `ALTER ROLE имя_роли VALID UNTIL '2023-12-31';`| Установить срок действия роли.                                         |

---

### **Пример ограничения подключений**
```sql
ALTER ROLE myuser WITH CONNECTION LIMIT 5;
```

---

### **Управление схемами**

| Команда                                      | Описание                                                                 |
|----------------------------------------------|-------------------------------------------------------------------------|
| `GRANT USAGE ON SCHEMA myschema TO myuser;`  | Дать право на использование схемы.                                      |
| `GRANT CREATE ON SCHEMA myschema TO myuser;` | Дать право на создание объектов в схеме.                                |

---

### **Пример работы со схемами**
```sql
GRANT USAGE ON SCHEMA public TO myuser;
GRANT SELECT ON ALL TABLES IN SCHEMA public TO myuser;
```

---

### **Управление наследованием прав**

| Команда                                      | Описание                                                                 |
|----------------------------------------------|-------------------------------------------------------------------------|
| `ALTER ROLE имя_роли WITH INHERIT;`          | Разрешить наследование прав от групп.                                   |
| `ALTER ROLE имя_роли WITH NOINHERIT;`        | Запретить наследование прав от групп.                                   |

---

### **Пример наследования прав**
```sql
GRANT mygroup TO myuser;
ALTER ROLE myuser WITH INHERIT;
```

---

### **Удаление ролей**

| Команда                                      | Описание                                                                 |
|----------------------------------------------|-------------------------------------------------------------------------|
| `DROP ROLE имя_роли;`                        | Удалить роль.                                                           |
| `DROP ROLE IF EXISTS имя_роли;`              | Удалить роль, если она существует.                                      |

---

### **Пример удаления роли**
```sql
DROP ROLE myuser;
```

---

### **Полезные команды**

| Команда                                      | Описание                                                                 |
|----------------------------------------------|-------------------------------------------------------------------------|
| `\l`                                        | Показать список всех баз данных.                                        |
| `\c имя_бд`                                 | Подключиться к базе данных.                                             |
| `\dt`                                       | Показать список таблиц в текущей базе данных.                           |
| `\dn`                                       | Показать список схем в текущей базе данных.                             |

---

### **Заключение**
Этот cheatsheet охватывает основные команды для управления пользователями, ролями и правами доступа в PostgreSQL. Используйте его как справочник для быстрой настройки и администрирования вашей базы данных.
